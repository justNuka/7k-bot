name: Build & Deploy to AlwaysData

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build artifacts & Deploy
    runs-on: ubuntu-latest
    
    # Ne d√©ployer que si [deploy] est dans le message de commit OU d√©clenchement manuel
    if: contains(github.event.head_commit.message, '[deploy]') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js (bot)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ========================================
      # BUILD BOT (TypeScript + prod node_modules)
      # ========================================
      - name: üî® Build bot
        working-directory: .
        run: |
          npm ci
          npm run build
          npm prune --omit=dev
      
      - name: üì¶ Pack bot artifacts
        run: |
          tar -czf bot-artifacts.tar.gz \
            dist/ \
            node_modules/ \
            package.json \
            package-lock.json
      
      # ========================================
      # DEPLOY TO ALWAYSDATA
      # ========================================
      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
      
      - name: üåê Add AlwaysData to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALWAYSDATA_HOST }} >> ~/.ssh/known_hosts
      
      - name: üì§ Upload artifacts to AlwaysData
        run: |
          scp bot-artifacts.tar.gz \
            ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }}:~/
      
      - name: üöÄ Deploy & restart on AlwaysData
        run: |
          ssh ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }} << 'EOF'
            set -e
            
            echo "üì¶ Deploying bot artifacts..."
            mkdir -p ~/apps/7k-bot
            
            # Backup .env if exists
            [ -f ~/apps/7k-bot/.env ] && cp ~/apps/7k-bot/.env ~/apps/7k-bot/.env.bak
            
            # Extract bot artifacts
            tar -xzf ~/bot-artifacts.tar.gz -C ~/apps/7k-bot
            rm -f ~/bot-artifacts.tar.gz
            
            # Restore .env
            [ -f ~/apps/7k-bot/.env.bak ] && mv ~/apps/7k-bot/.env.bak ~/apps/7k-bot/.env
            
            echo "ÔøΩ Restarting bot..."
            # Si PM2 est install√©, red√©marrer
            if command -v pm2 &> /dev/null; then
              pm2 restart 7k-bot || pm2 start dist/index.js --name 7k-bot
              pm2 save
            else
              echo "‚ö†Ô∏è PM2 not installed, manual restart required via AlwaysData UI"
            fi
            
            echo "‚úÖ Bot deployed successfully!"
          EOF
