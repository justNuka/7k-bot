name: Build & Deploy to AlwaysData

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build artifacts & Deploy
    runs-on: ubuntu-latest
    
    # Ne d√©ployer que si [deploy] est dans le message de commit
    if: contains(github.event.head_commit.message, '[deploy]')
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js (bot)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ========================================
      # BUILD BOT (TypeScript + prod node_modules)
      # ========================================
      - name: üî® Build bot
        working-directory: .
        run: |
          npm ci
          npm run build
          npm prune --omit=dev
      
      - name: üì¶ Pack bot artifacts
        run: |
          tar -czf bot-artifacts.tar.gz \
            dist/ \
            node_modules/ \
            package.json \
            package-lock.json
      
      # ========================================
      # CHECKOUT & BUILD DASHBOARD (Next.js standalone)
      # ========================================
      - name: üì• Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: justNuka/7k-bot-dashboard
          token: ${{ secrets.PAT_ACCESS_DASHBOARD }}
          path: dashboard
      
      - name: ÔøΩ Setup Node.js (dashboard)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      
      - name: üî® Build dashboard
        working-directory: dashboard
        run: |
          # Cr√©er un .env temporaire avec les variables n√©cessaires au build
          echo "SQLITE_PATH=/tmp/dummy.db" > .env
          echo "NEXTAUTH_SECRET=dummy-secret-for-build" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          echo "BOT_API_URL=http://localhost:8787" >> .env
          echo "DISCORD_CLIENT_ID=dummy" >> .env
          echo "DISCORD_CLIENT_SECRET=dummy" >> .env
          
          # Installer sqlite3 pour initialiser la DB
          sudo apt-get update && sudo apt-get install -y sqlite3
          
          # Cr√©er une DB SQLite avec le sch√©ma du bot
          mkdir -p /tmp
          # Copier le sch√©ma depuis le repo bot (d√©j√† clon√© dans le r√©pertoire parent)
          sqlite3 /tmp/dummy.db < ../src/db/schema.sql || echo "Schema applied (with warnings)"
          
          npm ci
          npm run build
      
      - name: üì¶ Pack dashboard artifacts
        working-directory: dashboard
        run: |
          # Next.js standalone inclut :
          # - .next/standalone/ (serveur + node_modules mini)
          # - .next/static/ (assets)
          # - public/ (fichiers statiques)
          tar -czf ../dashboard-artifacts.tar.gz \
            .next/standalone/ \
            .next/static/ \
            public/ || true
      
      # ========================================
      # DEPLOY TO ALWAYSDATA
      # ========================================
      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
      
      - name: üåê Add AlwaysData to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALWAYSDATA_HOST }} >> ~/.ssh/known_hosts
      
      - name: üì§ Upload artifacts to AlwaysData
        run: |
          scp bot-artifacts.tar.gz dashboard-artifacts.tar.gz \
            ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }}:~/
      
      - name: üöÄ Deploy & restart on AlwaysData
        run: |
          ssh ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }} << 'EOF'
            set -e
            
            echo "üì¶ Deploying bot artifacts..."
            mkdir -p ~/apps/7k-bot
            
            # Backup .env if exists
            [ -f ~/apps/7k-bot/.env ] && cp ~/apps/7k-bot/.env ~/apps/7k-bot/.env.bak
            
            # Extract bot artifacts
            tar -xzf ~/bot-artifacts.tar.gz -C ~/apps/7k-bot
            rm -f ~/bot-artifacts.tar.gz
            
            # Restore .env
            [ -f ~/apps/7k-bot/.env.bak ] && mv ~/apps/7k-bot/.env.bak ~/apps/7k-bot/.env
            
            echo "üì¶ Deploying dashboard artifacts..."
            mkdir -p ~/apps/7k-bot-dashboard
            
            # Backup .env if exists
            [ -f ~/apps/7k-bot-dashboard/.env ] && cp ~/apps/7k-bot-dashboard/.env ~/apps/7k-bot-dashboard/.env.bak
            
            # Extract dashboard artifacts
            tar -xzf ~/dashboard-artifacts.tar.gz -C ~/apps/7k-bot-dashboard
            rm -f ~/dashboard-artifacts.tar.gz
            
            # Restore .env
            [ -f ~/apps/7k-bot-dashboard/.env.bak ] && mv ~/apps/7k-bot-dashboard/.env.bak ~/apps/7k-bot-dashboard/.env
            
            echo "‚úÖ Deployment complete!"
            echo "‚ÑπÔ∏è  Restart apps via AlwaysData UI or API"
            
            # TODO: Ajouter restart automatique via AlwaysData API
          EOF
