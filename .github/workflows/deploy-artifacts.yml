name: Build & Deploy to AlwaysData

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build artifacts & Deploy
    runs-on: ubuntu-latest
    
    # Ne déployer que si [deploy] est dans le message de commit OU déclenchement manuel
    if: contains(github.event.head_commit.message, '[deploy]') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
      
      - name:  Setup Node.js (bot)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ========================================
      # BUILD BOT (TypeScript + prod node_modules)
      # ========================================
      - name:  Build bot
        working-directory: .
        run: |
          npm ci
          npm run build
          npm prune --omit=dev
      
      - name:  Pack bot artifacts
        run: |
          tar -czf bot-artifacts.tar.gz \
            dist/ \
            node_modules/ \
            package.json \
            package-lock.json
      
      # ========================================
      # DEPLOY TO ALWAYSDATA
      # ========================================
      - name:  Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
      
      - name:  Add AlwaysData to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALWAYSDATA_HOST }} >> ~/.ssh/known_hosts
      
      - name:  Upload artifacts to AlwaysData
        run: |
          scp bot-artifacts.tar.gz \
            ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }}:~/
      
      - name:  Deploy on AlwaysData
        run: |
          ssh ${{ secrets.ALWAYSDATA_USER }}@${{ secrets.ALWAYSDATA_HOST }} << 'EOF'
            set -e
            
            echo " Deploying bot artifacts..."
            mkdir -p ~/apps/7k-bot
            
            # Backup .env if exists
            [ -f ~/apps/7k-bot/.env ] && cp ~/apps/7k-bot/.env ~/apps/7k-bot/.env.bak
            
            # Extract bot artifacts
            tar -xzf ~/bot-artifacts.tar.gz -C ~/apps/7k-bot
            rm -f ~/bot-artifacts.tar.gz
            
            # Restore .env
            [ -f ~/apps/7k-bot/.env.bak ] && mv ~/apps/7k-bot/.env.bak ~/apps/7k-bot/.env
            
            echo " Registering Discord slash commands..."
            cd ~/apps/7k-bot
            npm run register:prod || echo " Command registration failed (non-blocking)"
            
            echo " Bot artifacts deployed!"
          EOF
      
      # Restart du service via l'API AlwaysData
      - name:  Restart bot service
        run: |
          SERVICE_ID="${{ secrets.ALWAYSDATA_SERVICE_ID }}"
          API_KEY="${{ secrets.ALWAYSDATA_API_KEY }}"
          ACCOUNT="${{ secrets.ALWAYSDATA_ACCOUNT }}"
          
          echo " Restarting bot service (ID: $SERVICE_ID)..."
          
          curl -X POST \
            -u "$ACCOUNT:$API_KEY" \
            "https://api.alwaysdata.com/v1/service/$SERVICE_ID/restart/" \
            -H "Content-Type: application/json"
          
          echo " Bot service restarted!"
