name: Deploy Both (Bot + Dashboard)

on:
  workflow_dispatch:
    inputs:
      restart_bot:
        description: 'Restart bot after deploy?'
        required: false
        type: boolean
        default: true
      restart_dashboard:
        description: 'Restart dashboard after deploy?'
        required: false
        type: boolean
        default: true

jobs:
  trigger-bot-deploy:
    name: Trigger Bot Deployment
    runs-on: ubuntu-latest
    steps:
      - name: ü§ñ Trigger bot workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'justNuka',
              repo: '7k-bot',
              workflow_id: 'deploy-artifacts.yml',
              ref: 'main'
            });
            console.log('‚úÖ Bot deployment triggered');

  trigger-dashboard-deploy:
    name: Trigger Dashboard Deployment
    runs-on: ubuntu-latest
    steps:
      - name: üåê Trigger dashboard workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_ACCESS_DASHBOARD }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'justNuka',
              repo: '7k-bot-dashboard',
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            console.log('‚úÖ Dashboard deployment triggered');

  wait-and-restart:
    name: Wait for deployments & Restart services
    runs-on: ubuntu-latest
    needs: [trigger-bot-deploy, trigger-dashboard-deploy]
    if: inputs.restart_bot || inputs.restart_dashboard
    steps:
      - name: ‚è≥ Wait for deployments to complete
        run: sleep 120  # Attendre 2 minutes

      - name: üîÑ Restart services via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALWAYSDATA_HOST }}
          username: ${{ secrets.ALWAYSDATA_USER }}
          key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            if [ "${{ inputs.restart_bot }}" = "true" ]; then
              echo "ü§ñ Restarting bot..."
              if command -v pm2 &> /dev/null; then
                pm2 restart 7k-bot || echo "‚ö†Ô∏è PM2 not found or bot not running"
              else
                # Fallback: kill and restart via systemd or autre
                echo "‚ö†Ô∏è PM2 not installed, manual restart required"
              fi
            fi
            
            if [ "${{ inputs.restart_dashboard }}" = "true" ]; then
              echo "üåê Restarting dashboard..."
              if command -v pm2 &> /dev/null; then
                pm2 restart dashboard || echo "‚ö†Ô∏è PM2 not found or dashboard not running"
              else
                echo "‚ö†Ô∏è PM2 not installed, manual restart required"
              fi
            fi
            
            echo "‚úÖ Restart complete!"
